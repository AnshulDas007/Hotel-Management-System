1. Trigger: Automatically Update Room Status on Reservation
This trigger updates the room status to "Occupied" when a reservation is confirmed and to "Available" when it is checked out or cancelled.

CREATE OR REPLACE TRIGGER trg_update_room_status
AFTER INSERT OR UPDATE OF status ON Reservation
FOR EACH ROW
BEGIN
    IF :NEW.status = 'Confirmed' THEN
        UPDATE Room
        SET status = 'Occupied'
        WHERE roomID = :NEW.roomID;

        DBMS_OUTPUT.PUT_LINE('Room ID ' || :NEW.roomID || ' status set to "Occupied" for Reservation ID ' || :NEW.resID);
    ELSIF :NEW.status IN ('Checked Out', 'Cancelled') THEN
        UPDATE Room
        SET status = 'Available'
        WHERE roomID = :NEW.roomID;

        DBMS_OUTPUT.PUT_LINE('Room ID ' || :NEW.roomID || ' status set to "Available" for Reservation ID ' || :NEW.resID);
    END IF;
END;
/


2. Function: Calculate Total Reservation Cost
This function calculates the total cost for a reservation based on the number of nights and the room's price per night.

CREATE OR REPLACE FUNCTION calculate_total_cost(
    p_reservation_id IN NUMBER
) RETURN NUMBER IS
    v_total_cost NUMBER;
    v_price_per_night NUMBER;
    v_checkin_date DATE;
    v_checkout_date DATE;
    v_nights NUMBER;
BEGIN
    -- Get the check-in date, check-out date, and room price per night
    SELECT checkInDate, checkOutDate, Room.pricePerNight
    INTO v_checkin_date, v_checkout_date, v_price_per_night
    FROM Reservation
    JOIN Room ON Reservation.roomID = Room.roomID
    WHERE Reservation.resID = p_reservation_id;

    -- Calculate the number of nights
    v_nights := v_checkout_date - v_checkin_date;

    -- Calculate the total cost
    v_total_cost := v_nights * v_price_per_night;

    -- Output the calculation details
    DBMS_OUTPUT.PUT_LINE('Reservation ID: ' || p_reservation_id);
    DBMS_OUTPUT.PUT_LINE('Check-in Date: ' || TO_CHAR(v_checkin_date, 'YYYY-MM-DD'));
    DBMS_OUTPUT.PUT_LINE('Check-out Date: ' || TO_CHAR(v_checkout_date, 'YYYY-MM-DD'));
    DBMS_OUTPUT.PUT_LINE('Nights: ' || v_nights);
    DBMS_OUTPUT.PUT_LINE('Price per Night: ' || v_price_per_night);
    DBMS_OUTPUT.PUT_LINE('Total Cost: ' || v_total_cost);

    RETURN v_total_cost;
END;
/

3. Procedure: Assign Staff to Service
This procedure assigns a staff member to a service provided to a guest.

CREATE OR REPLACE PROCEDURE assign_staff_to_service(
    p_staff_id IN NUMBER,
    p_service_id IN NUMBER,
    p_room_id IN NUMBER,
    p_service_date IN DATE,
    p_service_details IN CLOB
) IS
BEGIN
    INSERT INTO RoomService (roomServiceID, roomID, serviceID, staffID, serviceDate, serviceDetails)
    VALUES (
        RoomService_seq.NEXTVAL, 
        p_room_id,
        p_service_id,
        p_staff_id,
        p_service_date,
        p_service_details
    );
    
    DBMS_OUTPUT.PUT_LINE('Assigned Staff ID ' || p_staff_id || ' to Service ID ' || p_service_id);
    DBMS_OUTPUT.PUT_LINE('Room ID: ' || p_room_id);
    DBMS_OUTPUT.PUT_LINE('Service Date: ' || TO_CHAR(p_service_date, 'YYYY-MM-DD'));
    DBMS_OUTPUT.PUT_LINE('Service Details: ' || p_service_details);

    -- Removed COMMIT to comply with trigger restrictions
END;
/

4.a trigger on the GuestService table to automatically call the procedure

CREATE OR REPLACE TRIGGER trg_assign_staff_to_service
AFTER INSERT ON GuestService
FOR EACH ROW
DECLARE
    v_staff_id NUMBER;
    v_room_id NUMBER;
    v_service_details CLOB;
BEGIN
    -- Attempt to find the first available staff member for the service
    SELECT MIN(staffID)
    INTO v_staff_id
    FROM StaffService
    WHERE serviceID = :NEW.serviceID;

    -- Attempt to find a room ID for the guest's confirmed reservation
    SELECT roomID
    INTO v_room_id
    FROM Reservation
    WHERE guestID = :NEW.guestID
    AND status = 'Confirmed'
    AND ROWNUM = 1;

    -- Placeholder for service details
    v_service_details := 'Auto-assigned service based on guest request';

    -- Call the procedure to assign the staff to the service
    assign_staff_to_service(
        p_staff_id => v_staff_id,
        p_service_id => :NEW.serviceID,
        p_room_id => v_room_id,
        p_service_date => SYSDATE,
        p_service_details => v_service_details
    );

EXCEPTION
    -- Handle case where no staff is available
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Error: No staff available for Service ID ' || :NEW.serviceID);

    -- Handle all other exceptions
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Unexpected error occurred: ' || SQLERRM);
END;
/




